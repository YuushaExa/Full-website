{{ define "main" }}
<section class="section">
  <article>      
    <div class="container">
      <div class="post">
        <h1 data-pagefind-ignore class="post-title"><a href="{{ .Permalink }}">{{ .Title }}</a></h1>
  <div class="content">
    <span>Favorites: <p id="totalCount-fav"></p></span>
   <button class="syncfav">Sync</button>
    <div class="syncfavmenu">
    <input type="text" id="inputTextFavSet" placeholder="Save in Cloud" readonly="readonly"/>
    <button id="sendDataButton">Save in Cloud</button>
    <button id="getDataButton" disabled>Load from Cloud</button>
    <input type="text" id="inputTextFav" minlength="8" placeholder="Put key here" />
    </div>
    <div id="cardContainer"></div>   
     </div>
    </div>     </div>  
  </article>    
</section>
<script>
 const sendDataButton = document.getElementById('sendDataButton');
  const inputTextFavSet = document.getElementById('inputTextFavSet');

const urlsync = "https://fav2.pages.dev/v";

fetch(urlsync)
  .then(response => {
    if (response.ok) {
      return response.text();
    }
    throw new Error("Error: Failed to fetch the URL");
  })
  .then(syncget => {
    const token = syncget;
  })
  .catch(error => {
    console.error(error);
  });
  
  inputTextFavSet.addEventListener('input', function () {
    if (inputTextFavSet.value.length >= 8) {
      sendDataButton.disabled = false;
    } else {
      sendDataButton.disabled = true;
    }
  });

  sendDataButton.addEventListener('click', sendDataToGitHub);

function sendDataToGitHub() {
  const localStorageData = JSON.stringify(localStorage); // Assuming local storage data is already in JSON format

  // GitHub repository information
  const owner = 'YuushaExa';
  const repo = 'web';
  const branch = 'master';
  const directory = 'dev/json/favfiles';
  var filename = document.getElementById("inputTextFavSet").value;

  const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${directory}/${filename}.json`;
  // Create the file content object
  const encoder = new TextEncoder();
  const dataEncoded = encoder.encode(localStorageData);
  const base64Data = base64ArrayBuffer(dataEncoded);

  // Make a separate API request to get the SHA of the existing file
  fetch(apiUrl, {
    method: 'GET',
    headers: {
      Authorization: `Bearer ${token}`,
    },
  })
    .then(response => response.json())
    .then(data => {
      const existingFileSha = data.sha;

      // Update the file content object with the existing file's SHA
      const fileContent = {
        message: 'Update data.json from local storage',
        content: base64Data,
        sha: existingFileSha, // Include the SHA of the existing file
      };

      // Make the API request to create or update the file
      fetch(apiUrl, {
        method: 'PUT',
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(fileContent),
      })
        .then(response => response.json())
        .then(data => {
          console.log('File created or updated successfully:', data);
          // Change inputTextFavSet background color to green for 3 seconds
          document.getElementById("inputTextFavSet").style.backgroundColor = 'green';
          setTimeout(() => {
            document.getElementById("inputTextFavSet").style.backgroundColor = '';
          }, 3000);
        })
        .catch(error => {
          console.error('Error creating or updating the file:', error);
          // Change inputTextFavSet background color to red
          document.getElementById("inputTextFavSet").style.backgroundColor = 'red';
        });
    })
    .catch(error => {
      console.error('Error retrieving existing file information:', error);
      // Change inputTextFavSet background color to red
      document.getElementById("inputTextFavSet").style.backgroundColor = 'red';
    });
}

// Function to convert the ArrayBuffer to a base64 string
function base64ArrayBuffer(arrayBuffer) {
  let binary = '';
  const bytes = new Uint8Array(arrayBuffer);
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

document.addEventListener("DOMContentLoaded", function() {
  var syncfavElements = document.getElementsByClassName("syncfav");
  var syncfavClickHandler = function() {
    var synckey = generateSynckey(8);
    document.getElementById("inputTextFavSet").value = synckey;
    for (var i = 0; i < syncfavElements.length; i++) {
      syncfavElements[i].removeEventListener("click", syncfavClickHandler);
    }
  };

  for (var i = 0; i < syncfavElements.length; i++) {
    syncfavElements[i].addEventListener("click", syncfavClickHandler);
  }
});

    function generateSynckey(length) {
      var charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      var synckey = "";
      for (var i = 0; i < length; i++) {
        var randomIndex = Math.floor(Math.random() * charset.length);
        synckey += charset.charAt(randomIndex);
      }
      return synckey;
    }
  
// Function to fetch JSON data and store in local storage
function fetchDataAndStoreInLocalStorage() {
  var trm = document.getElementById("inputTextFav").value;
  var url = `https://raw.githubusercontent.com/YuushaExa/web/master/dev/json/favfiles/${trm}.json`;
  
  // Change inputTextFav background color to green for 3 seconds
  function setSuccessBackgroundColor() {
    document.getElementById("inputTextFav").style.backgroundColor = "green";
    setTimeout(function() {
      document.getElementById("inputTextFav").style.backgroundColor = "";
    }, 3000);
  }
  
  // Change inputTextFav background color to red
  function setErrorBackgroundColor() {
    document.getElementById("inputTextFav").style.backgroundColor = "red";
  }

  fetch(url)
    .then(response => response.json())
    .then(data => {
      for (const key in data) {
        if (data.hasOwnProperty(key)) {
          const value = data[key];
          localStorage.setItem(key, value);
        }
      }
      console.log('JSON data stored in local storage');
      setSuccessBackgroundColor(); // Call the success background color function
    })
    .catch(error => {
      console.error('Error fetching JSON data:', error);
      setErrorBackgroundColor(); // Call the error background color function
    });
}
// Button click event handler
   const getDataButton = document.getElementById('getDataButton');
  const inputTextFav = document.getElementById('inputTextFav');

  inputTextFav.addEventListener('input', function () {
    if (inputTextFav.value.length >= 8) {
      getDataButton.disabled = false;
    } else {
      getDataButton.disabled = true;
    }
  });

  getDataButton.addEventListener('click', fetchDataAndStoreInLocalStorage);
</script>
<script>
window.onload = function() {
  displaySavedCards();
  attachToggleListeners();

var toggleButtons = document.querySelectorAll('.toggleButton path');
toggleButtons.forEach(function(button) {
  button.style.fill = 'unset';
});
var toggleButtons1 = document.querySelectorAll('.toggleButtonSVG');
toggleButtons1.forEach(function(button1) {
  button1.style.fill = 'rgb(4 252 14 / 80%)';
});
};
</script>
{{ end }}
