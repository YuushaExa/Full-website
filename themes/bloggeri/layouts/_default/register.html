{{ define "main" }}
<section class="section">
  <article>      
    <div class="container">
      <div class="post">
        <h1 data-pagefind-ignore class="post-title"><a href="{{ .Permalink }}">{{ .Title }}</a></h1>
  <div class="content">
        <div class="columns is-multiline">
<h2>Registration Form</h2>
<form id="registrationForm">
  <label for="registrationEmail">Email:</label>
  <input type="email" id="registrationEmail" name="email" required><br><br>
  <label for="registrationPassword">Password:</label>
  <input type="password" id="registrationPassword" name="password" required><br><br>
  <button type="submit">Register</button>
</form>

<form id="registrationFormNick">
  <label for="nickname">Nickname:</label>
  <input type="text" id="nickname" name="nickname" required><br><br>
  <label for="password">Password:</label>
  <input type="password" id="password" name="password" required><br><br>
  <button type="submit">Register</button>
</form>
          
<form id="loginForm">
  <label for="loginEmail">Email/Nickname:</label>
  <input type="text" id="loginEmail" name="email">
  <br>
  <label for="loginPassword">Password:</label>
  <input type="password" id="loginPassword" name="password" required>
  <br>
  <button type="submit">Login</button>
</form>

 <h2>Update Email Address</h2>
  <form>
    <label for="newEmail">New Email Address:</label>
    <input type="email" id="newEmail" required>
    <br><br>
    <button type="button" onclick="updateEmail()">Update Email</button>
  </form>
          
          <div id="buttonaccount">
            <button id="cloudsave">Save to Firebase Storage</button>
          <button id="loadcloudsave">Load Cloud Save</button>
<button id="logout">Logout</button>
            <button id="deleteAccount">Delete Account</button>
   <button id="deletesaved">Delete Save Data</button>
               <button id="resetpassword">Reset Password</button>
          </div>
              
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script>
  var firebaseConfig = {
    apiKey: "AIzaSyCP3lyYIs5GjA6XYS9aSdaz5X6-ru3Fxeo",
    authDomain: "gamedb-95862.firebaseapp.com",
    databaseURL: "https://gamedb-95862-default-rtdb.firebaseio.com",
    projectId: "gamedb-95862",
    storageBucket: "gamedb-95862.appspot.com",
    messagingSenderId: "788250168154",
    appId: "1:788250168154:web:b6573c45a909fc09694163"
  };
  firebase.initializeApp(firebaseConfig);

// Email Registration
  
  // Get the registration form element
  const registrationForm = document.getElementById('registrationForm');

  // Add an event listener to the registration form
  registrationForm.addEventListener('submit', (e) => {
    e.preventDefault(); // Prevent the form from submitting

    // Get user input values
    const email = registrationForm.email.value;
    const password = registrationForm.password.value;

    // Create a new user with email and password
    firebase.auth().createUserWithEmailAndPassword(email, password)
      .then((userCredential) => {
        // Registration successful
        const user = userCredential.user;
        console.log('Registration successful:', user);
        // You can redirect the user to a different page or perform additional actions here
      })
      .catch((error) => {
        // Registration failed
        const errorCode = error.code;
        const errorMessage = error.message;
        console.error('Registration failed:', errorCode, errorMessage);
        // Display an error message to the user or handle the error appropriately
      });
  });

  // Nickname Registration 

  const registrationFormNick = document.getElementById('registrationFormNick');

registrationFormNick.addEventListener('submit', (e) => {
  e.preventDefault();

  const nickname = registrationFormNick.nickname.value;
  const password = registrationFormNick.password.value;

  firebase.auth().createUserWithEmailAndPassword(`${nickname}@example.com`, password)
    .then((userCredential) => {
      const user = userCredential.user;
      console.log('Registration successful:', user);
      // Additional actions or redirection can be performed here
    })
    .catch((error) => {
      const errorCode = error.code;
      const errorMessage = error.message;
      console.error('Registration failed:', errorCode, errorMessage);
      // Display an error message to the user or handle the error appropriately
    });
});

  // login

const loginForm = document.getElementById('loginForm');

// Add an event listener to the login form
loginForm.addEventListener('submit', (e) => {
  e.preventDefault(); // Prevent the form from submitting

  // Get user input values
  let email = loginForm.email.value;
  const password = loginForm.password.value;

  // Check if the input is in email format
  const emailRegex = /\S+@\S+\.\S+/;
  if (!emailRegex.test(email)) {
    // Append '@example.com' to the word entered by the user
    email += '@example.com';
  }

  // Sign in the user with email and password
  firebase.auth().signInWithEmailAndPassword(email, password)
    .then((userCredential) => {
      // Login successful
      const user = userCredential.user;
      console.log('Login successful:', user);
      // You can redirect the user to a different page or perform additional actions here
    })
    .catch((error) => {
      // Login failed
      const errorCode = error.code;
      const errorMessage = error.message;
      console.error('Login failed:', errorCode, errorMessage);
      // Display an error message to the user or handle the error appropriately
    });
});
  
// log out

  // Get the logout button element
const logoutButton = document.getElementById('logout');

// Add an event listener to the logout button
logoutButton.addEventListener('click', () => {
  // Sign out the user
  firebase.auth().signOut()
    .then(() => {
      // Logout successful
      console.log('Logout successful');
      // You can redirect the user to a different page or perform additional actions here
    })
    .catch((error) => {
      // Logout failed
      console.error('Logout failed:', error);
      // Display an error message to the user or handle the error appropriately
    });
});

  // delete

const deleteAccountButton = document.getElementById('deleteAccount');

// Add an event listener to the delete account button
deleteAccountButton.addEventListener('click', () => {
  // Get the currently logged-in user
  const user = firebase.auth().currentUser;

  // Prompt the user for re-authentication (e.g., password confirmation) before deleting the account
  const password = prompt('Please enter your password to confirm account deletion:');

  // Create a credential with the user's email and password
  const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);

  // Re-authenticate the user with the provided credential
  user.reauthenticateWithCredential(credential)
    .then(() => {
      // Get the user's UID
      const uid = user.uid;

      // Delete the associated Firebase Storage folder
      const storage = firebase.storage();
      const storageRef = storage.ref();
      var folderPath = 'data/' + uid + '/' + uid + '.json';

      storageRef.child(folderPath).delete()
        .then(() => {
          // Successful deletion of associated storage folder
          console.log('Associated storage folder deleted successfully:', folderPath);

          // Delete the user account
          user.delete()
            .then(() => {
              // Account deletion successful
              console.log('Account deletion successful');
              // You can redirect the user to a different page or perform additional actions here
            })
            .catch((error) => {
              // Account deletion failed
              console.error('Account deletion failed:', error);
              // Display an error message to the user or handle the error appropriately
            });
        })
        .catch((error) => {
          // Error deleting associated storage folder
          console.error('Error deleting associated storage folder:', folderPath, error);
          // Display an error message to the user or handle the error appropriately

          // Continue with account deletion even if storage deletion failed
          user.delete()
            .then(() => {
              // Account deletion successful
              console.log('Account deletion successful');
              // You can redirect the user to a different page or perform additional actions here
            })
            .catch((error) => {
              // Account deletion failed
              console.error('Account deletion failed:', error);
              // Display an error message to the user or handle the error appropriately
            });
        });
    })
    .catch((error) => {
      // Re-authentication failed
      console.error('Re-authentication failed:', error);
      // Display an error message to the user or handle the error appropriately
    });
});
  
  // cloud save

 const cloudSaveButton = document.getElementById('cloudsave');

// Add an event listener to the cloudsave button
cloudSaveButton.addEventListener('click', () => {
// Get the current user
const user = firebase.auth().currentUser;

if (user) {
  // Generate a unique file name using the user's UID
  const fileName = user.uid + '.json';

  // Convert localStorage data to JSON
  const localStorageData = JSON.stringify(localStorage);

  // Compress the localStorageData using LZString
  const compressedData = LZString.compressToEncodedURIComponent(localStorageData);

  // Create a reference to the Firebase Storage folder
  const storageRef = firebase.storage().ref();

  // Create a child reference with the file path and upload the data
  const fileRef = storageRef.child('data/' + user.uid + '/' + fileName);
  fileRef.putString(compressedData, 'raw')
    .then(() => {
      console.log('Data saved to Firebase Storage successfully.');
    })
    .catch((error) => {
      console.error('Data upload to Firebase Storage failed:', error);
    });
} else {
  console.error('User not logged in.');
}
});
  
  // cloud load 

 document.getElementById('loadcloudsave').addEventListener('click', function() {
  const user = firebase.auth().currentUser;

  if (user) {
    // Generate the file name based on the user's UID
    const fileName = user.uid + '.json';

    // Create a reference to the Firebase Storage file
    const storageRef = firebase.storage().ref();
    const fileRef = storageRef.child('data/' + user.uid + '/' + fileName);

    // Get the download URL for the file
fileRef.getDownloadURL()
  .then((downloadURL) => {
    // Use the download URL to retrieve the file data
    fetch(downloadURL)
      .then((response) => response.text())
      .then((compressedData) => {
        // Decompress the compressed data using LZString
        const localStorageData = LZString.decompressFromEncodedURIComponent(compressedData);

        // Parse the decompressed data as JSON
        const data = JSON.parse(localStorageData);
        console.log('Retrieved data:', data);

        // Store each key-value pair in localStorage
        for (let key in data) {
          localStorage.setItem(key, data[key]);
        }

        // Do something with the retrieved data if needed
      })
      .catch((error) => {
        console.error('Error retrieving data:', error);
      });
  })
  .catch((error) => {
    console.error('Error getting download URL:', error);
  });
  } else {
    console.error('User not logged in.');
  }
});

  // auth console
  
  firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    // User is logged in
    console.log('User logged in:', user);
  } else {
    // User is logged out
    console.log('User logged out.');
  }
});

  // delete button

// Assuming you have already initialized Firebase SDK and authenticated the user

// Get the button element
var deleteButton = document.getElementById('deletesaved');

deleteButton.addEventListener('click', function() {
  // Get the current user
  var user = firebase.auth().currentUser;

  // Check if a user is available
  if (user) {
    // Get the current user's UID
    var uid = user.uid;
    var storage = firebase.storage();
    var storageRef = storage.ref();
    var folderPath = 'data/' + uid + '/' + uid + '.json';

    storageRef.child(folderPath).delete()
      .then(function() {
        console.log('File deleted successfully:', folderPath);
        // Perform any additional actions after successful deletion
      })
      .catch(function(error) {
        console.error('Error deleting file:', folderPath, error);
        // Handle any errors that occur during deletion
      });
  } else {
    console.log('No user is currently signed in.');
    // Handle the case when no user is signed in
  }
});

  // Reset password
const resetPasswordButton = document.getElementById('resetpassword');

  resetPasswordButton.addEventListener('click', (e) => {
  e.preventDefault(); // Prevent the button from triggering a form submission

  // Get user input value
  const email = registrationForm.email.value;

  // Send password reset email
  firebase.auth().sendPasswordResetEmail(email)
    .then(() => {
      // Password reset email sent successfully
      console.log('Password reset email sent successfully');
      // You can display a success message to the user or perform additional actions here
    })
    .catch((error) => {
      // Password reset email failed
      const errorCode = error.code;
      const errorMessage = error.message;
      console.error('Password reset email failed:', errorCode, errorMessage);
      // Display an error message to the user or handle the error appropriately
    });
});

  // Update email

   // Function to update email address
    function updateEmail() {
      var user = firebase.auth().currentUser;
      var newEmail = document.getElementById("newEmail").value;

      user.updateEmail(newEmail).then(function() {
        // Email address updated successfully
        alert("Email address updated!");
      }).catch(function(error) {
        // An error occurred while updating email address
        alert("Error updating email address: " + error.message);
      });
    }
</script>
          
          
     </div>
    </div>     </div>   </div>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  </article>    
</section>
{{ end }}
